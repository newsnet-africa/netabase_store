name: Lint

on:
  push:
    branches: [main, develop, sync]
  pull_request:
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: clippy

      - name: Run clippy (native - all backends)
        run: |
          cargo clippy --features native --all-targets -- -W clippy::all \
            -A dead_code \
            -A unused_imports \
            -A clippy::enum_variant_names \
            -A clippy::collapsible_if \
            -A clippy::type_complexity \
            -A clippy::too_many_arguments \
            -A clippy::redundant_closure \
            -A clippy::needless_return \
            -A clippy::clone_on_copy \
            -A clippy::drop_non_drop \
            -A clippy::empty_line_after_doc_comments \
            -A clippy::large_enum_variant \
            -A clippy::manual_map \
            -A clippy::map_clone \
            -A clippy::needless_borrow \
            -A clippy::ptr_arg \
            -A clippy::suspicious_doc_comments \
            -A clippy::to_string_in_format_args

      - name: Run clippy (sled only)
        run: |
          cargo clippy --features sled --lib -- -D warnings \
            -A clippy::enum_variant_names \
            -A clippy::type_complexity \
            -A clippy::needless_borrow \
            -A clippy::empty_line_after_doc_comments \
            -A clippy::collapsible_if \
            -A clippy::suspicious_doc_comments \
            -A clippy::manual_map \
            -A clippy::drop_non_drop \
            -A clippy::clone_on_copy \
            -A clippy::redundant_closure \
            -A clippy::to_string_in_format_args \
            -A clippy::map_clone \
            -A clippy::large_enum_variant \
            -A unexpected_cfgs

      - name: Run clippy (redb only)
        run: |
          cargo clippy --features redb --lib -- -D warnings \
            -A clippy::enum_variant_names \
            -A clippy::type_complexity \
            -A clippy::needless_borrow \
            -A clippy::empty_line_after_doc_comments \
            -A clippy::collapsible_if \
            -A clippy::suspicious_doc_comments \
            -A clippy::manual_map \
            -A clippy::drop_non_drop \
            -A clippy::clone_on_copy \
            -A clippy::redundant_closure \
            -A clippy::to_string_in_format_args \
            -A clippy::map_clone \
            -A clippy::large_enum_variant \
            -A unexpected_cfgs

      - name: Run clippy (redb-zerocopy)
        run: |
          cargo clippy --features redb-zerocopy --lib -- -D warnings \
            -A clippy::enum_variant_names \
            -A clippy::type_complexity \
            -A clippy::needless_borrow \
            -A clippy::empty_line_after_doc_comments \
            -A clippy::collapsible_if \
            -A clippy::suspicious_doc_comments \
            -A clippy::manual_map \
            -A clippy::drop_non_drop \
            -A clippy::clone_on_copy \
            -A clippy::redundant_closure \
            -A clippy::to_string_in_format_args \
            -A clippy::map_clone \
            -A clippy::large_enum_variant \
            -A unexpected_cfgs

  rustfmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: doc

      - name: Check documentation (native)
        run: cargo doc --features native --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Check documentation (redb-zerocopy)
        run: cargo doc --features redb-zerocopy --no-deps
        env:
          RUSTDOCFLAGS: -D warnings
