name: CI

on:
  push:
    branches: [main, develop, sync]
  pull_request:
    branches: [main, develop]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Test with individual backends
  test-sled:
    name: Test Sled Backend
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-sled-${{ matrix.os }}

      - name: Run tests (sled only)
        run: cargo test --lib --features sled --verbose

      - name: Run comprehensive tests (sled)
        run: cargo test --test comprehensive_store_tests --features sled --verbose

  test-redb:
    name: Test Redb Backend
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-redb-${{ matrix.os }}

      - name: Run tests (redb only)
        run: cargo test --lib --features redb --verbose

  test-redb-zerocopy:
    name: Test Redb ZeroCopy Backend
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-zerocopy-${{ matrix.os }}

      - name: Run tests (redb-zerocopy only)
        run: cargo test --lib --features redb-zerocopy --verbose

      - name: Run zerocopy tests
        run: cargo test --test redb_zerocopy_tests --features redb-zerocopy --verbose

  test-native:
    name: Test Native (All Backends)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-native

      - name: Run tests (native - all backends)
        run: cargo test --lib --features native --verbose

      - name: Run backend CRUD tests
        run: cargo test --test backend_crud_tests --features native --verbose

      - name: Run sled store tests
        run: cargo test --test sled_store_tests --features native --verbose

      - name: Run netabase comprehensive tests
        run: cargo test --test netabase_store_comprehensive_tests --features native --verbose

      - name: Run cross-store tests
        run: cargo test --test cross_store_compat_tests --features native --verbose

      - name: Run doctests
        run: cargo test --doc --features native --verbose

  test-additional:
    name: Additional Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-additional

      - name: Run convenience key functions tests
        run: cargo test --test convenience_key_functions_test --features native --verbose

      - name: Run generic constructor tests
        run: cargo test --test generic_new_constructor_test --features native --verbose

      - name: Run simple macro tests
        run: cargo test --test simple_macro_test --features native --verbose

      - name: Run redb basic tests
        run: cargo test --test redb_basic_test --features redb --verbose

  test-combinations:
    name: Test Feature Combinations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: test-combinations

      - name: Test sled + redb
        run: cargo test --lib --features "sled,redb" --verbose

      - name: Test sled + redb + redb-zerocopy
        run: cargo test --lib --features "sled,redb,redb-zerocopy" --verbose

      - name: Test with libp2p
        run: cargo test --lib --features "native,libp2p" --verbose

      - name: Test record store
        run: cargo test --test record_store_tests --features "native,record-store" --verbose

  bench:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: bench

      - name: Check benchmarks compile
        run: cargo bench --features native --no-run

  examples:
    name: Build Examples
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: examples

      - name: Build examples (native)
        run: cargo build --examples --features native --verbose

      - name: Build config showcase example
        run: cargo build --example config_api_showcase --features "native,redb-zerocopy" --verbose

      - name: Build redb examples
        run: cargo build --example redb_basic --example redb_zerocopy --features "redb,redb-zerocopy" --verbose

      - name: Build unified API example
        run: cargo build --example unified_api --features native --verbose

      - name: Build transaction examples
        run: cargo build --example transactions --features native --verbose

      - name: Build batch operation examples
        run: cargo build --example batch_operations --example batch_import --example batch_atomicity --features native --verbose

  # Quick smoke test to ensure basic functionality
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: smoke

      - name: Run basic_store example
        run: timeout 30 cargo run --example basic_store --features native

      - name: Run config showcase example
        run: timeout 30 cargo run --example config_api_showcase --features "native,redb-zerocopy"

      - name: Run unified_api example
        run: timeout 30 cargo run --example unified_api --features native
