# Quick Profiling Guide

## ⚠️ IMPORTANT: You MUST use --profile-time flag

Flamegraphs are **NOT** generated by default when running `cargo bench`.

You **MUST** use the `--profile-time` flag:

```bash
# ❌ WRONG - No flamegraphs generated
cargo bench

# ✅ CORRECT - Flamegraphs will be generated
cargo bench -- --profile-time=5
```

## Quick Start

### Option 1: Use the helper script
```bash
./profile_benches.sh
```

### Option 2: Manual command
```bash
# Profile all benchmarks (takes ~5 seconds per benchmark)
cargo bench -- --profile-time=5

# Profile specific benchmark
cargo bench --bench sled_wrapper_overhead -- --profile-time=5

# Profile specific test
cargo bench --bench sled_wrapper_overhead -- --profile-time=5 insert
```

## Viewing Flamegraphs

After running with `--profile-time`, flamegraphs are saved to:
```
target/criterion/<benchmark_name>/profile/flamegraph.svg
```

**View in browser:**
```bash
# Linux
xdg-open target/criterion/insert/wrapper/100/profile/flamegraph.svg

# macOS
open target/criterion/insert/wrapper/100/profile/flamegraph.svg
```

**Find all flamegraphs:**
```bash
find target/criterion -name "flamegraph.svg"
```

## Why --profile-time is Required

The profiler uses CPU sampling which needs continuous execution time:
- `cargo bench` - Runs multiple short iterations (statistics mode)
- `cargo bench -- --profile-time=5` - Runs continuously for 5 seconds (profiling mode)

Without `--profile-time`, the benchmark iterations are too short for meaningful profiling data.

## Examples

**Compare sled wrapper overhead:**
```bash
cargo bench --bench sled_wrapper_overhead -- --profile-time=5 insert

# Then compare:
xdg-open target/criterion/insert/raw_sled/100/profile/flamegraph.svg
xdg-open target/criterion/insert/wrapper/100/profile/flamegraph.svg
```

**Profile redb secondary key lookup:**
```bash
cargo bench --bench redb_wrapper_overhead -- --profile-time=5 secondary

xdg-open target/criterion/redb_secondary_key_lookup/wrapper/profile/flamegraph.svg
```

## See Also

- Full profiling guide: [PROFILING.md](./PROFILING.md)
- Benchmark documentation: `cargo doc --open`
