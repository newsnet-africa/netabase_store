# Netabase Store - Quick Reference

## Overview

Netabase Store is a type-safe, cross-platform database abstraction layer that works seamlessly across native (Sled) and WebAssembly (IndexedDB) environments with optional libp2p integration.

## Key Concepts

### Definitions
Enum-based schemas that organize multiple model types:
```rust
pub enum BlogDefinition {
    User(User),
    Post(Post),
}
```

### Keys
Type-safe key enums for efficient lookups:
```rust
pub enum UserKey {
    Primary(UserPrimaryKey),
    Secondary(UserSecondaryKeys),
}
```

### Models
Data structures with automatic key derivation:
```rust
#[derive(NetabaseModel, ...)]
pub struct User {
    #[primary_key]
    pub id: u64,
    #[secondary_key]
    pub email: String,
}
```

## Quick Start

```rust
// 1. Define schema
#[netabase_definition_module(BlogDefinition, BlogKeys)]
mod blog {
    #[derive(NetabaseModel, ...)]
    pub struct User {
        #[primary_key]
        pub id: u64,
        pub name: String,
    }
}

// 2. Create store
let store = SledStore::<BlogDefinition>::new(path)?;

// 3. Use typed trees
let tree = store.open_tree::<User>();
tree.put(user)?;
let user = tree.get(UserPrimaryKey(1))?;
```

## Features

| Feature | Native | WASM | Purpose |
|---------|--------|------|---------|
| `native` | ✓ | | Sled backend |
| `wasm` | | ✓ | IndexedDB backend |
| `libp2p` | ✓ | ✓ | DHT integration |

## Storage Backends

- **Sled** (native): Embedded B+ tree database
- **IndexedDB** (WASM): Browser persistent storage
- **Memory**: In-memory for testing

## Core Traits

- `Store<D>`: Store management
- `StoreTree<M>`: CRUD operations
- `NetabaseModel`: Model interface
- `NetabaseDefinition`: Schema interface
- `KademliaRecord`: libp2p integration (optional)

## Common Operations

### CRUD
```rust
tree.put(model)?;                    // Create/Update
tree.get(primary_key)?;              // Read
tree.remove(primary_key)?;           // Delete
```

### Queries
```rust
tree.get_by_secondary_key(key)?;     // Secondary key lookup
tree.iter();                         // Full scan
tree.len()?;                         // Count records
```

### Atomic
```rust
tree.compare_and_swap(key, old, new)?;   // CAS operation
tree.fetch_and_update(key, |old| ...)?;  // Atomic update
```

## Architecture

```
Application
    ↓
Definition/Keys (Generated by macros)
    ↓
Store/StoreTree Traits
    ↓
Backend (Sled | IndexedDB | Memory)
    ↓
Storage (File | Browser DB | RAM)
```

## Performance

- **Sled**: 10-20μs read, 50-100μs write
- **IndexedDB**: Async, browser-dependent
- **Memory**: < 1μs operations

## Examples

- `03_libp2p_records.rs`: DHT integration
- `05_indexeddb_wasm.rs`: WASM usage

## Testing

```bash
# Native
cargo test --features native

# WASM
wasm-pack test --headless --firefox --features wasm
```

## Links

- [Full README](./README.md)
- [Examples](./examples/)
- [Tests](./tests/)
- [Benchmarks](./benches/)
